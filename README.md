This is the front-end of the Power Dashboard application. It's developed using Next.js. See [rcpss-sutech.ir](http://rcpss-sutech.ir/)
Developed By [Amirreza Yarahmadi](https://github.com/amirreza-yar/)

## مقدمه

برنامه تحت وب توسعه داده‌ام از Django و Django Rest Framework (DRF) برای ایجاد سرویس‌های قدرتمند API در بک‌اند و از Next.js برای ایجاد رابط کاربری کاربری واکنش‌پذیر در فرانت‌اند بهره می‌برد. در این برنامه، یک Power Meter پیچیده به منظور نصب در محیط‌های مسکونی عملکرد می‌کند. این دستگاه نقش کلیدی در جمع‌آوری و انتقال داده‌های دقیق مصرف برق دارد.

### عملکرد Power Meter

Power Meter معیارهای ضروری از جمله جریان ("I") و ولتاژ ("V") را به همراه زمان‌های دقیق ثبت می‌کند. در مرحله بعد، این داده به API بک‌اند ارسال می‌شود. بک‌اند که از Django و DRF بهره می‌برد، تجزیه و تحلیل جامع داده را انجام داده و محاسبات لازم را انجام داده و از فیلترهای پیچیده برای به دست آوردن داده‌های معنی‌دار استفاده می‌کند.

### فناوری‌های Bک‌اند

Django و DRF به‌طور کلی یک چارچوب بک‌اند قدرتمند را شکل می‌دهند که اطمینان از انتقال و پردازش امن و کارآمد داده را به دنبال دارد. بک‌اند داده‌های مصرف برق را با دقت ذخیره و کنترل می‌کند، که به بازیابی و ارائه سریع آن در فرانت‌اند امکان می‌دهد.

### رابط کاربری فرانت‌اند

برای توسعه فرانت‌اند، Next.js به‌عنوان یک چارچوب قدرتمند انتخاب شده است. با شناخته‌شدن به‌عنوان یک چارچوب چندمنظوره و توانمند در ایجاد رابط‌های کاربری جذاب، Next.js تجربه‌ای نرم و پرسپرکتیو را ارائه می‌دهد. فرانت‌اند نه تنها داده‌های پردازش شده مصرف برق را به تصویر می‌کشد بلکه اطمینان از ارائه یک نمایش مفهومی و جذاب برای کاربران دارد.

### مرور مقاله

در ادامه، این مقاله شما را از اجزاء و عملکردهای مختلف این برنامه تحت وب همراه با پیاده‌سازی بک‌اند، توسعه رابط کاربری فرانت‌اند، جزییات پردازش داده، معماری سیستم، چالش‌های مواجهه شده و راهبردهای تست استفاده شده هدایت می‌کند. این مقاله به دنبال فراهم کردن درک جامع از برنامه و قابلیت‌های آن برای توسعه‌دهندگان و کاربران می‌باشد.

حالا می‌توانیم به مرحله بعدی برویم و به بررسی مفصل فناوری‌های به‌کاررفته در این برنامه تحت وب بپردازیم.


# فناوری‌های به‌کاررفته

## چارچوب Django و Django Rest Framework (DRF)

### Django:
Django به عنوان چارچوب اصلی بک‌اند استفاده شده است و وظیفه توسعه سریع وب‌سایت‌ها و اپلیکیشن‌ها را برعهده دارد. از ORM قوی Django برای سهولت در ارتباط با دیتابیس استفاده شده است.

### Django Rest Framework (DRF):
DRF به‌عنوان یک فریم‌ورک برای توسعه وب‌سرویس‌های RESTful API در Django مورد استفاده قرار گرفته است. این فریم‌ورک امکانات مفیدی برای ساخت و مدیریت API‌های وب ارائه داده و نقش مهمی در برقراری ارتباط بین فرانت‌اند و بک‌اند دارد.

## چارچوب Next.js

### Next.js:
Next.js برای توسعه فرانت‌اند از چارچوب React استفاده شده و برنامه را به شکل SPA اجرا می‌کند. این چارچوب با امکانات SSR و ISG، تجربه کاربری را بهبود بخشیده و به نمایش گذاشتن داده‌های پردازش‌شده از بک‌اند را فراهم می‌کند.

## فناوری‌های Bold

### RESTful API:
استفاده از الگوی طراحی RESTful API برای برقراری ارتباط بین بک‌اند و فرانت‌اند، امکانات مناسبی برای ارسال و درخواست داده فراهم می‌کند.

### SPA Application:
استفاده از برنامه تحت وب با رابط کاربری اسپا که به کاربر اجازه می‌دهد بدون نیاز به بارگیری مجدد صفحات، با برنامه تعامل کند.

### PWA (Progressive Web App):
تبدیل برنامه به شکل PWA که امکان اجرا در حالت آفلاین و ارسال اعلان‌های دسکتاپ را داراست و تجربه کاربری را بهبود می‌بخشد.

### JWT Token (JSON Web Token):
استفاده از JWT Token برای امنیت داده‌ها و احراز هویت کاربران در سیستم.

### Django ORM (Object-Relational Mapping):
استفاده از Django ORM برای تسهیل در ارتباط با داده‌های دیتابیس و ساختاردهی بهتر آنها.

### Django Filters:
استفاده از Django Filters برای اعمال فیلترها و جستجوی پیشرفته در داده‌های مدل بک‌اند.

### Pandas:
استفاده از کتابخانه Pandas برای تحلیل و پردازش داده‌های ساختار یافته در بک‌اند.

## ماژول‌ها و کامپوننت‌ها

## ۳.۱ دیتابیس

### نوع دیتابیس
در این پروژه از دیتابیس SQLite به‌عنوان دیتابیس پیش‌فرض Django استفاده شده است.

### مدل‌ها و جداول

#### custom_user.models
این ماژول شامل یک مدل به‌نام `CustomUser` است که از `AbstractUser` مدل پیش‌فرض Django ارث‌بری کرده است. این مدل اطلاعات مربوط به کاربران را در سیستم نگهداری می‌کند. 

- **CustomUser:**
    - `uuid`: یک شناسه یکتا برای هر کاربر.
    - `username`: نام کاربری.
    - `password`: رمز عبور.
    - `first_name`: نام.
    - `last_name`: نام خانوادگی.
    - `email`: ایمیل کاربر.
    - (سایر فیلدها و خصوصیات مدل `AbstractUser` که به‌صورت پیش‌فرض ارائه شده‌اند)

#### power_dashboard.models
این ماژول شامل یک مدل به‌نام `PowerMeter` است که اطلاعات مربوط به داده‌های اندازه‌گیری شده توسط متر برق را ذخیره می‌کند.

- **PowerMeter:**
    - `user`: یک کلید خارجی که به `CustomUser` متصل است و نشان‌دهنده کاربر مربوط به هر اندازه‌گیری است.
    - `current`: جریان برق اندازه‌گیری شده.
    - `voltage`: ولتاژ برق اندازه‌گیری شده (با مقدار پیش‌فرض ۲۲۰).
    - `datetime`: تاریخ و زمان اندازه‌گیری برق.
    - (سایر فیلدها و خصوصیات مدل که به‌صورت خاص برای این اپلیکیشن ارائه شده‌اند)

### جزئیات فیلدها

#### `CustomUser`:
- `uuid`: 
  - نوع: CharField
  - محدودیت‌ها: حداکثر طول ۲۲ کاراکتر، یکتا و قابل ویرایش نیست.
- `username`:
  - نوع: CharField
  - محدودیت‌ها: حداکثر طول ۱۵۰ کاراکتر، یکتا.
- `password`:
  - نوع: CharField
  - محدودیت‌ها: -
- `first_name`:
  - نوع: CharField
  - محدودیت‌ها: حداکثر طول ۳۰ کاراکتر.
- `last_name`:
  - نوع: CharField
  - محدودیت‌ها: حداکثر طول ۳۰ کاراکتر.
- `email`:
  - نوع: EmailField
  - محدودیت‌ها: یکتا.

#### `PowerMeter`:
- `user`:
  - نوع: ForeignKey به `CustomUser`
  - محدودیت‌ها: مرتبط با کلید اصلی `CustomUser`.
- `current`:
  - نوع: FloatField
  - محدودیت‌ها: -
- `voltage`:
  - نوع: FloatField
  - محدودیت‌ها: مقدار پیش‌فرض ۲۲۰.
- `datetime`:
  - نوع: DateTimeField
  - محدودیت‌ها: مقدار پیش‌فرض `timezone.now`.
 ## 3.1 Back-end

### Django
Django یک چارچوب توسعه وب قدرتمند در پایتون است که برای پیاده‌سازی بک‌اند این اپلیکیشن مورد استفاده قرار گرفته است. این چارچوب ارائه دهنده ابزارها و پترن‌هایی برای تسهیل و تسریع فرآیند توسعه است و از مدل MTV (Model-Template-View) برای ساختاردهی پروژه‌ها استفاده می‌کند.

#### معماری Django
- **MTV (Model-Template-View):**
    - **Model:** مسئولیت دارد که اطلاعات (داده‌ها) را مدل‌سازی کند و با دیتابیس ارتباط برقرار کند. در پروژه، مدل‌ها در فایل‌های `models.py` قرار دارند.
    - **Template:** به‌صورت کلی UI (رابط کاربری) را تعریف کرده و اطلاعات را به شکل قالب‌های دلخواه به‌نمایش می‌گذارد. در پروژه، این بخش در قالب فایل‌های HTML است.
    - **View:** اطلاعات را از مدل‌ها گرفته و به قالب می‌رساند. همچنین این بخش درخواست‌ها و واکنش‌های سمت سرور را مدیریت می‌کند. در پروژه، این بخش در فایل‌های `views.py` قرار دارد.

#### ساختار پروژه Django
یک پروژه Django از چندین برنامه (App) تشکیل شده است. هر برنامه مسئولیت خاص خود را دارد و از ابزارها و توابع Django استفاده می‌کند. ساختار معمول یک پروژه Django شامل موارد زیر است:
- **Project:** یک پروژه Django که دارای تنظیمات کلی پروژه است.
- **App:** برنامه‌های جزئی دیگر که قسمت‌های مختلف عملکردی را پیاده‌سازی می‌کنند.

#### فایل‌ها و کامپوننت‌ها
- **`views.py`:**
    - در این فایل، توابع نمایش (Views) برای پردازش درخواست‌ها و ارسال واکنش‌ها به کلاینت پیاده‌سازی می‌شوند.
- **`models.py`:**
    - این فایل شامل مدل‌های داده‌ای است که توسط Django برای ساخت جداول در دیتابیس استفاده می‌شوند.
- **`filters.py`:**
    - در این فایل، فیلترها برای فیلتر کردن داده‌ها در درخواست‌های API پیاده‌سازی می‌شوند.
- **`serializers.py`:**
    - این فایل‌ها برای تبدیل مدل‌ها به فرمت‌هایی چون JSON استفاده می‌شوند، که در ارتباط با API‌ها کاربرد دارند.

- **`urls.py`:**
        در این فایل، آدرس‌های اینترنتی (URLs) برای تطابق با درخواست‌ها و انتقال آنها به توابع نمایش مشخص می‌شوند. این اطلاعات معمولاً در ارتباط با API استفاده می‌شود و برای مسیریابی مناسب در اپلیکیشن استفاده می‌شود.
    
- **`admin.py`:**
        در این فایل، مدل‌ها به سیستم مدیریت Django اضافه شده و امکان مدیریت داده‌ها از طریق پنل ادمین فراهم می‌شود.
    
- **`apps.py`:**
        در این فایل، تنظیمات برنامه و اطلاعات دیگری که برای Django اهمیت دارند، قرار می‌گیرد.
    
- **`renderers.py`:**
        این فایل حاوی تعیین کننده‌های اضافی برای تبدیل نتایج API به فرمت‌های مختلف مانند JSON یا XML می‌باشد.
    
- **`tests.py`:**
        فایل تست برای نوشتن تست‌های واحد برای برنامه، به منظور اطمینان از صحت عملکرد اجزای مختلف.


### برنامه `custom_auth`

#### فایل `models.py`

در این فایل، مدل `CustomUser` برای ایجاد جدول کاربران سفارشی در دیتابیس تعریف شده است. این مدل از `AbstractUser` ارث‌بری کرده و یک فیلد UUID برای شناسایی یکتا به هر کاربر اضافه کرده است.
*   `CustomUser`:
    *   `UUID_FIELD`: نام فیلد مسئول برای نگهداری UUID.
    *   `uuid`: یک فیلد CharField که برای نگهداری UUID کاربران استفاده می‌شود.
    *   `save`: یک متد برای ذخیره UUID به صورت اتوماتیک در هنگام ذخیره‌سازی اطلاعات کاربر.

```python
class CustomUser(AbstractUser):
    UUID_FIELD = 'uuid'
    
    uuid = models.CharField(max_length=22, unique=True, editable=False)

    def save(self, *args, **kwargs):
        if not self.uuid:
            self.uuid = base64.urlsafe_b64encode(uuid.uuid4().bytes).rstrip(b'=').decode('utf-8')[:8]
        super().save(*args, **kwargs)
```


#### فایل `views.py`
در این فایل، توابع نمایش برای مدیریت توکن‌ها (Token) برای ورود به سیستم (`TokenObtainPairView` و `TokenRefreshView`) تعریف شده‌اند. همچنین یک سری سریالایزرها جهت سفارشی‌سازی فرایند گرفتن توکن (`CustomTokenObtainPairSerializer`) و تازه‌سازی توکن (`CustomTokenRefreshView`) موجود است.

*   `CustomTokenObtainPairSerializer`:

    *   یک سری کدهای سریالایزر برای نگهداری UUID به جای نام کاربری و ایجاد توکن.
    *   بررسی وجود حساب کاربری فعال با UUID و رمزعبور.
    *   ایجاد توکن‌های دسترسی و تازه‌سازی.
*   `CustomTokenObtainPairView`:

    *   یک نمایش برای درخواست گرفتن توکن با استفاده از `CustomTokenObtainPairSerializer`.
*   `CustomTokenRefreshView`:

    *   یک نمایش برای درخواست تازه‌سازی توکن.

```python
class CustomTokenObtainPairSerializer(TokenObtainPairSerializer):
    # ... کدهای سریالایزر

class CustomTokenObtainPairView(TokenObtainPairView):
    # ... کدهای نمایش برای گرفتن توکن

class CustomTokenRefreshView(TokenRefreshView):
    # ... کدهای نمایش برای تازه‌سازی توکن

```


#### فایل `urls.py`
در این فایل، آدرس‌های اینترنتی (URLs) مربوط به توکن‌ها تعریف شده‌اند. این URLs شامل آدرس‌هایی برای گرفتن توکن (`token_obtain_pair`) و تازه‌سازی توکن (`token_refresh`) هستند.

*   `urlpatterns`:
    *   URL برای گرفتن توکن (`api/token/`).
    *   URL برای تازه‌سازی توکن (`api/token/refresh/`).

```python
from django.urls import path
from .views import CustomTokenObtainPairView, CustomTokenRefreshView

urlpatterns = [
    # ... دیگر الگوهای URL
    path('api/token/', CustomTokenObtainPairView.as_view(), name='token_obtain_pair'),
    path('api/token/refresh/', CustomTokenRefreshView.as_view(), name='token_refresh'),
]

```
### برنامه `power_dashboard`

### فایل `models.py`

در این فایل، مدل `PowerMeter` برای نمایش داده‌های مربوط به مصرف برق تعریف شده است.

*   **PowerMeter:**
    *   `user`: یک کلید خارجی به `CustomUser` که نشان‌دهنده کاربر مربوطه است.

    *   `current`: یک فیلد `FloatField` برای ذخیره جریان برق.

    *   `voltage`: یک فیلد `FloatField` برای ذخیره ولتاژ برق با مقدار پیش‌فرض ۲۲۰.

    *   `datetime`: یک فیلد `DateTimeField` برای ذخیره تاریخ و زمان ثبت داده.

    *   خصوصیات محاسباتی:

        *   `power`: محاسبه توان مصرفی با استفاده از جریان و ولتاژ.
        *   `date`: بازگرداندن تاریخ محلی.
        *   `jdate`: تاریخ به شمسی.
        *   `time`: زمان محلی.

### فایل `serializers.py`

در این فایل، سریالایزرهای مختلف برای مدل `PowerMeter` و مدل‌های مرتبط تعریف شده‌اند.

*   **UserSerializer:**

    *   برای سریالایزر کاربران سفارشی.
*   **GroupSerializer:**

    *   برای سریالایزر گروه‌ها.
*   **PowerMeterSerializer:**

    *   برای سریالایزر داده‌های `PowerMeter`.
    *   شامل فیلدهای مهم مانند `power`، `datetime`، `current` و `voltage`.
*   **PowerMeterExportSerializer:**

    *   برای سریالایزر خروجی داده‌های `PowerMeter`.
    *   شامل فیلدهایی مانند `power`، `jdate`، `time` و `user_uuid`.
*   **HourlyPowerSerializer:**

    *   برای سریالایزر مصرف ساعتی با فیلدهای `power` و `hour`.
*   **DailyStatSerializer:**

    *   برای سریالایزر آمار روزانه با فیلدهای `date`، `min_power`، `max_power` و `avg_power`.
*   **MinMaxPowerSerializer:**

    *   برای سریالایزر مصرف با فیلدهای `power`، `date`، `min_power` و `max_power`.
*   **AvgPowerSerializer:**

    *   برای سریالایزر میانگین مصرف با فیلدهای `avg_power`، `date`، `datetime` و `hour`.

### فایل `filters.py`

در این فایل، فیلترهای مختلف برای فیلتر کردن داده‌های `PowerMeter` بر اساس تاریخ تعریف شده‌اند.

*   **PowerMeterDateFilter:**

    *   فیلتر بر اساس تاریخ برای تعیین داده‌های مصرفی در یک روز خاص.
*   **DailyStatFilter:**

    *   فیلتر بر اساس تاریخ برای تولید آمار روزانه از داده‌های مصرفی.
*   **MinMaxPowerDateFilter:**

    *   فیلتر بر اساس تاریخ برای محاسبه حداقل و حداکثر مصرف در بازه‌های زمانی مختلف.
*   **AvgPowerDateFilter:**

    *   فیلتر بر اساس تاریخ برای محاسبه میانگین مصرف در بازه‌های زمانی مختلف.

### فایل `views.py.py`

در این فایل، این ViewSets و API ها برای ارائه و مدیریت اطلاعات مصرف برق کاربران به صورت گسترده و کارآمد طراحی شده‌اند.

### **UserViewSet:**

*   **هدف:** این ViewSet مسئول عملیات CRUD بر روی کاربران سفارشی است.
*   **فیلترها:** هیچ فیلتری اعمال نمی‌شود.
*   **جزئیات:**
    *   از مدل `CustomUser` استفاده می‌کند.
    *   عملیات معمول CRUD را برای کاربران پشتیبانی می‌کند (لیست، ایجاد، بازیابی، به‌روزرسانی، حذف).
    *   محدود به کاربران ادمین است.

### **GroupViewSet:**

*   **هدف:** مدیریت عملیات CRUD بر روی گروه‌های کاربری.
*   **فیلترها:** هیچ فیلتری اعمال نمی‌شود.
*   **جزئیات:**
    *   از مدل داخلی Django `Group` استفاده می‌کند.
    *   عملیات معمول CRUD را پشتیبانی می‌کند.
    *   محدود به کاربران ادمین است.

### **RealTimeViewSet:**

*   **هدف:** ارائه داده‌های مصرف برق به صورت زمان واقعی برای کاربر احراز هویت شده.
*   **فیلترها:** داده‌ها بر اساس کاربر احراز هویت شده فیلتر می‌شوند.
*   **جزئیات:**
    *   آخرین داده‌های مصرف برق را برای کاربر احراز هویت شده بازیابی می‌کند.
    *   میانگین مصرف برق را محاسبه کرده و نتیجه را به صورت JSON بازمی‌گرداند.
    *   از `PowerMeterSerializer` برای سریال‌سازی استفاده می‌کند.
    *   تنها به درخواست‌های `GET` پاسخ می‌دهد.

### **DailyStatViewSet:**

*   **هدف:** محاسبه و ارائه آمار روزانه مصرف برق.
*   **فیلترها:** داده‌ها بر اساس بازه زمانی مشخص و کاربر احراز هویت شده فیلتر می‌شوند.
*   **جزئیات:**
    *   داده‌های مصرف برق را برای بازه زمانی مشخص بازیابی می‌کند.
    *   مصرف انرژی روزانه برای هر روز در داخل بازه محاسبه شده و بازمی‌گردانده می‌شود.
    *   از `DailyStatSerializer` برای سریال‌سازی استفاده می‌کند.
    *   از درخواست‌های `GET` پشتیبانی می‌کند.

### **EnergyStatViewSet:**

*   **هدف:** محاسبه و ارائه آمار مصرف انرژی برای بازه‌های زمانی مختلف.
*   **فیلترها:** داده‌ها بر اساس بازه زمانی مشخص و کاربر احراز هویت شده فیلتر می‌شوند.
*   **جزئیات:**
    *   پارامتر پرس‌وجو `range` را برای تعیین بازه زمانی (آخرین 7 روز، آخرین 14 روز، آخرین 30 روز) می‌پذیرد.
    *   مصرف انرژی را برای هر روز در داخل بازه مشخص محاسبه کرده و بازمی‌گرداند.
    *   از `DailyStatSerializer` برای سریال‌سازی استفاده می‌کند.
    *   از درخواست‌های `GET` پشتیبانی می‌کند.

### **PowerMeterViewSet:**

*   **هدف:** مدیریت عملیات CRUD بر روی داده‌های مصرف برق.
*   **فیلترها:** داده‌ها بر اساس بازه زمانی مشخص فیلتر می‌شوند اگر مشخص شود.
*   **جزئیات:**
    *   عملیات معمول CRUD را پشتیبانی می‌کند.
    *   اقدامات اختصاصی (`add_data` و `add_data_dev`) برای افزودن داده‌های مصرف برق ارائه می‌کند.
    *   اقدام `add_data` امکان افزودن یک نقطه داده از طریق پارامترهای پرس‌وجو را فراهم می‌کند.
    *   اقدام `add_data_dev` نیز برای افزودن داده‌های انبوه برای اهداف توسعه استفاده می‌شود.
    *   از `PowerMeterSerializer` برای سریال‌سازی استفاده می‌کند.

### **PowerMeterCSVExportAPIView:**

*   **هدف:** صدور داده‌های مصرف برق به فرمت CSV برای تاریخ مشخص.
*   **فیلترها:** داده‌ها بر اساس تاریخ مشخص و کاربر احراز هویت شده فیلتر می‌شوند.
*   **جزئیات:**
    *   پارامتر پرس‌وجوی `date` را برای مشخص کردن تاریخ صدور داده‌ها می‌پذیرد.
    *   از `PowerMeterExportSerializer` برای سریال‌سازی استفاده می‌کند.
    *   یک فایل CSV به عنوان پاسخ با داده‌های مشخص شده برای تاریخ مشخص بازمی‌گردانده می‌شود.

### **ValidateJWTToken:**

*   **هدف:** اعتبارسنجی و تازه‌سازی توکن‌های JWT.
*   **فیلترها:** هیچ فیلتری اعمال نمی‌شود.
*   **جزئیات:**
    *   نیاز به ورود کاربر دارد.
    *   توکن JWT را اعتبارسنجی کرده و اگر توکن هنوز اعتبار دارد، یک توکن دسترسی جدید را بازمی‌گرداند.
    *   اطلاعاتی راجع به کاربر و انقضاء توکن را ارائه می‌دهد.

این ViewSets به طور گسترده از API ها برای مدیریت و تجزیه و تحلیل داده‌های مصرف برق ارائه می‌دهند، با ویژگی‌های متنوع از بازیابی داده‌های زمان واقعی تا تجزیه و تحلیل آماری برای بازه‌های زمانی مختلف.

### فایل `urls.py`:

1.  **UserViewSet و GroupViewSet:**

    *   `router.register(r'users', UserViewSet)`: این مسیر برای CRUD کاربران است و از `UserViewSet` استفاده می‌کند.
    *   `router.register(r'groups', GroupViewSet)`: مشابهاً، این مسیر برای CRUD گروه‌ها است و از `GroupViewSet` استفاده می‌کند.
2.  **RealTimeViewSet:**

    *   `router.register(r'realtime', RealTimeViewSet)`: این مسیر برای ارائه داده‌های برق به صورت زمان واقعی برای کاربر احراز هویت شده استفاده می‌شود.
3.  **DailyStatViewSet:**

    *   `router.register(r'daily-stat', DailyStatViewSet)`: این مسیر برای محاسبه و ارائه آمار روزانه مصرف برق برای یک روز خاص استفاده می‌شود.
4.  **EnergyStatViewSet:**

    *   `router.register(r'energy-stat', EnergyStatViewSet)`: این مسیر برای محاسبه و ارائه آمار مصرف انرژی بر اساس بازه‌های زمانی مختلف (7 روز، 14 روز، 30 روز) استفاده می‌شود.
5.  **PowerMeterViewSet:**

    *   `router.register(r'power', PowerMeterViewSet)`: این مسیر برای CRUD نمونه‌های مدل `PowerMeter` استفاده می‌شود.
    *   `path('power-export', PowerMeterCSVExportAPIView.as_view())`: این مسیر برای صادر کردن داده‌های برق به صورت CSV بر اساس تاریخ مشخص استفاده می‌شود.
6.  **ValidateJWTToken:**

    *   `path('validate-token/', ValidateJWTToken.as_view())`: این مسیر برای اعتبارسنجی و تازه‌سازی توکن JWT استفاده می‌شود.

پس از راه اندازی `router` با `router.register`، تمامی URL های مرتبط با viewsets به صورت اتوماتیک تولید می‌شوند و به `urlpatterns` اضافه می‌شوند. این اتصالات URL به viewsets به شرح زیر هستند:

*   `/users/`: CRUD کاربران با استفاده از `UserViewSet`.
*   `/groups/`: CRUD گروه‌ها با استفاده از `GroupViewSet`.
*   `/power/`: CRUD نمونه‌های مدل `PowerMeter` با استفاده از `PowerMeterViewSet`.
*   `/realtime/`: اطلاعات برق به صورت زمان واقعی با استفاده از `RealTimeViewSet`.
*   `/daily-stat/`: آمار روزانه مصرف برق با استفاده از `DailyStatViewSet`.
*   `/energy-stat/`: آمار مصرف انرژی بر اساس بازه‌های زمانی مختلف با استفاده از `EnergyStatViewSet`.
*   `/power-export/`: صادر کردن داده‌های برق به صورت CSV با استفاده از `PowerMeterCSVExportAPIView`.
*   `/validate-token/`: اعتبارسنجی و تازه‌سازی توکن JWT با استفاده از `ValidateJWTToken`.

## 3.2 Front-end

### Next.js

Next.js یک چارچوب توسعه وب بر پایه React است که برای پیاده‌سازی قسمت فرانت‌اند این اپلیکیشن مورد استفاده قرار گرفته است. این چارچوب ابزارها و پترن‌هایی را برای تسهیل توسعه وب ارائه می‌دهد و از مدل ساختاری از نوع Server-Side Rendering (SSR) و Static Site Generation (SSG) برای بهبود عملکرد و تجربه کاربری استفاده می‌کند.

#### معماری Next.js

*   **Server-Side Rendering (SSR):**
    *   این مدل به Next.js اجازه می‌دهد که قبل از ارسال صفحه به مرورگر، سمت سرور اطلاعات را بر روی صفحه اجرا کند. این کمک می‌کند تا محتوا به صورت پویا تولید شود.
*   **Static Site Generation (SSG):**
    *   Next.js از این مدل برای ایجاد صفحات ایستا استفاده می‌کند. صفحات به صورت پیش‌فرض به صورت استاتیک تولید می‌شوند که منجر به بهبود سرعت بارگذاری صفحات می‌شود.

#### ساختار پروژه Next.js

پروژه Next.js از چندین کامپوننت تشکیل شده است که هرکدام وظایف خود را دارند.

#### فایل‌ها و کامپوننت‌ها

*   **`pages/`:**

    *   این دایرکتوری حاوی فایل‌های جی‌اس (JS) یا تی‌اس‌اکس (TSX) است که هر فایل معادل با یک مسیر اینترنتی است. هر فایل در این دایرکتوری به یک صفحه منحصر به فرد متصل می‌شود.
*   **`components/`:**

    *   در این دایرکتوری، کامپوننت‌های React که می‌توانند در صفحات مختلف استفاده شوند، قرار دارند.
*   **`styles/`:**

    *   این دایرکتوری حاوی فایل‌های استایل (CSS یا SCSS) برای طراحی و زیبایی صفحات است.
*   **`public/`:**

    *   در این دایرکتوری، فایل‌ها و تصاویر استاتیک قرار می‌گیرند که ممکن است در صفحات نیاز باشد.
*   **`api/`:**

    *   این دایرکتوری می‌تواند شامل فایل‌های مربوط به ارتباط با API و درخواست‌های شبکه باشد.
*   **`util/`:**

    *   در این دایرکتوری، ابزارها و توابع کمکی قرار دارند که ممکن است در انجام وظایف مختلف به کار بروند.
*   **`next.config.js`:**

    *   این فایل حاوی تنظیمات و پیکربندی‌های مربوط به پروژه Next.js است که می‌تواند شامل تغییرات در مسیرها یا تنظیمات دیگر برای ساخت پروژه باشد.
*   **`package.json`:**

    *   در این فایل اطلاعات مربوط به وابستگی‌ها و ابزارهای مورد استفاده در پروژه قرار دارد.
*   **`yarn.lock` یا `package-lock.json`:**

    *   این فایل‌ها حاوی اطلاعات مربوط به وابستگی‌ها و نحوه نصب آن‌ها هستند.

#### درخت پروژه Next.js
```bash
project-nextjs/
│
├── pages/
│   ├── index.js
│   ├── about.js
│   └── ...
│
├── components/
│   ├── Header.js
│   ├── Footer.js
│   └── ...
│
├── styles/
│   ├── main.css
│   └── ...
│
├── public/
│   ├── images/
│   └── ...
│
├── api/
│   ├── user.js
│   ├── power.js
│   └── ...
│
├── util/
│   ├── helper.js
│   └── ...
│
├── next.config.js
├── package.json
├── yarn.lock
└── ...

```

### ساختار فرانت‌اند (`Next.js`)
‍‍‍‍```bashproject-nextjs/
│
├── app/
│   ├── page.js
│   ├── layout.js
│   ├── loading.js
│   └──dashboard
│             ├── page.js
│             ├── layout.js
│             └──login
│                      ├── page.js
│ 
├── components/
│   ├── charts
│             ├── ColPowerChart.jsx
│             ├── PowerChart.jsx
│             ├── PiePowerChart.jsx
│             ├── PredictCost.jsx
│             ├── utils
│                       ├── Download.jsx
│                       ├── FormatPersianTime.jsx
│                       ├── LoadCharts.jsx
│                       ├── NumberCounter.jsx
│                       ├── TranslateToPersian.jsx
│   ├── ChartLayout.jsx
│   ├── DashboardLayout.jsx
│   ├── Loaders.jsx
│   ├── Message.jsx
│   ├── Navbar.jsx
│   ├── ProtectedPages.jsx
│   ├── SideBarNav.jsx
│   ├── UnProtectedPages.jsx
│
├── public/
│   ├── images/
│   └── ...
│
└──context/
    ├── AuthContext.js
    ├── MessageContext.js
    └──context.js```

### **پوشه `app/`:**
   - **`page.js`:**
        - این فایل احتمالاً یک قالب یا ساختار صفحه عمومی را نمایش می‌دهد.
   - **`layout.js`:**
        - یک کامپوننت طراحی که ساختار یکنواختی را برای صفحات فراهم می‌کند.
   - **`loading.js`:**
        - یک کامپوننت یا ابزار برای مدیریت وضعیت بارگیری یا اسپینر.
   - **`dashboard/` Directory:**
        - **`page.js`:**
            - ساختار یا قالب صفحات داشبورد را نمایش می‌دهد.
        - **`layout.js`:**
            - یک کامپوننت طراحی اختصاصی به داشبورد.
        - **`login/` Directory:**
            - **`page.js`:**
                - ساختار یا قالب صفحات ورود به سیستم.

### **پوشه `components/`:**
   - **`charts/` Directory:**
        - **`ColPowerChart.jsx`:**
            - یک کامپوننت برای نمایش یک نمودار ستونی مرتبط با برق.
        - **`PowerChart.jsx`:**
            - یک کامپوننت برای نمایش نمودار کلی برق.
        - **`PiePowerChart.jsx`:**
            - یک کامپوننت برای نمایش نمودار دایره‌ای مرتبط با برق.
        - **`PredictCost.jsx`:**
            - یک کامپوننت برای نمایش پیش‌بینی‌های مرتبط با هزینه.
        - **`utils/` Directory:**
            - **`Download.jsx`:**
                - یک ابزار برای مدیریت دانلود.
            - **`FormatPersianTime.jsx`:**
                - یک ابزار برای فرمت‌بندی زمان به فارسی.
            - **`LoadCharts.jsx`:**
                - یک ابزار برای بارگیری نمودارها.
            - **`NumberCounter.jsx`:**
                - یک ابزار برای شمارش اعداد.
            - **`TranslateToPersian.jsx`:**
                - یک ابزار برای ترجمه به فارسی.
   - **`ChartLayout.jsx`:**
        - یک کامپوننت طراحی که به صورت خاص برای نمایش چارت‌ها طراحی شده است.
   - **`DashboardLayout.jsx`:**
        - یک کامپوننت طراحی برای صفحات داشبورد.
   - **`Loaders.jsx`:**
        - مجموعه‌ای از کامپوننت‌های لودر برای مدیریت وضعیت بارگیری.
   - **`Message.jsx`:**
        - یک کامپوننت برای نمایش پیام‌ها یا هشدارها.
   - **`Navbar.jsx`:**
        - یک کامپوننت نوار ناوبری.
   - **`ProtectedPages.jsx`:**
        - یک کامپوننت که طراحی صفحات محافل را ارائه می‌دهد، احتمالاً آنها را در یک context provider بسته می‌شود.
   - **`SideBarNav.jsx`:**
        - یک کامپوننت نوار کناری.
   - **`UnProtectedPages.jsx`:**
        - یک کامپوننت که طراحی صفحات بدون محافل را ارائه می‌دهد، احتمالاً آنها را در یک context provider بسته می‌شود.

### **پوشه `public/`:**
   - **`images/` Directory:**
        - شامل تصاویر استاتیک مورد استفاده در اپلیکیشن.

### **پوشه `context/`:**
   - **`AuthContext.js`:**
        - مدیریت context مرتبط با احراز هویت، احتمالاً توکن کاربر را دریافت کرده و بعد از ورود موفقیت‌آمیز، از آن در هدرهای درخواست‌ها استفاده می‌کند.
   - **`MessageContext.js`:**
        - مدیریت context مرتبط با پیام‌ها یا هشدارها.
   - **`context.js`:**
        - احتمالاً یک ابزار یا فایل context اصلی است که انواع مختلف context را ترکیب کرده و به عنوان یک context جهانی به کامپوننت‌های شما ارائه می‌دهد.


## **معماری توده‌ای (Full Stack Architecture)**

### **Back-end (Django)**

#### **1\. مدل‌های Django (`models.py`):**

*   **مدل PowerMeter:**
    *   فیلدها: `user` (کلید خارجی به `CustomUser`), `current`, `voltage`, `datetime`.
    *   فیلدهای محاسباتی: `power`, `date`, `jdate`, `time`.

#### **2\. سریالایزرهای Django (`serializers.py`):**

*   **UserSerializer:**
    *   سریالایزر برای مدل `CustomUser`.
*   **GroupSerializer:**
    *   سریالایزر برای مدل معمولی Django به نام `Group`.
*   **PowerMeterSerializer:**
    *   سریالایزر برای مدل `PowerMeter` با فیلدهای `power`, `datetime`, `current`, و `voltage`.
*   **PowerMeterExportSerializer:**
    *   سریالایزر برای صدور داده با فیلدهای `power`, `jdate`, `time`, و `user_uuid`.
*   **HourlyPowerSerializer:**
    *   سریالایزر برای مصرف ساعتی با فیلدهای `power` و `hour`.
*   **DailyStatSerializer:**
    *   سریالایزر برای آمار روزانه با فیلدهای `date`, `min_power`, `max_power`, و `avg_power`.
*   **MinMaxPowerSerializer:**
    *   سریالایزر برای مصرف با فیلدهای `power`, `date`, `min_power`, و `max_power`.
*   **AvgPowerSerializer:**
    *   سریالایزر برای میانگین مصرف با فیلدهای `avg_power`, `date`, `datetime`, و `hour`.

#### **3\. فیلترهای Django (`filters.py`):**

*   **PowerMeterDateFilter:**
    *   فیلتر بر اساس تاریخ برای داده‌های مصرفی در یک روز خاص.
*   **DailyStatFilter:**
    *   فیلتر بر اساس تاریخ برای تولید آمار روزانه از داده‌های مصرفی.
*   **MinMaxPowerDateFilter:**
    *   فیلتر بر اساس تاریخ برای محاسبه حداقل و حداکثر مصرف در بازه‌های زمانی مختلف.
*   **AvgPowerDateFilter:**
    *   فیلتر بر اساس تاریخ برای محاسبه میانگین مصرف در بازه‌های زمانی مختلف.

#### **4\. نماهای Django (`views.py`):**

*   **UserViewSet:**
    *   عملیات CRUD بر روی کاربران سفارشی. تنها توسط کاربران ادمین قابل دسترس است.
*   **GroupViewSet:**
    *   عملیات CRUD بر روی گروه‌های کاربری. تنها توسط کاربران ادمین قابل دسترس است.
*   **PowerMeterViewSet:**
    *   عملیات CRUD بر روی داده‌های مصرف برق.
    *   عملیات سفارشی: `add_data` و `add_data_dev` برای افزودن داده‌های مصرف برق.
*   **RealTimeViewSet:**
    *   اطلاعات مصرف برق به صورت زمان واقعی برای کاربر احراز هویت شده فراهم می‌کند.
*   **DailyStatViewSet:**
    *   آمار روزانه برای مصرف برق محاسبه و فراهم می‌کند.
*   **EnergyStatViewSet:**
    *   آمار مصرف انرژی برای بازه‌های زمانی مختلف محاسبه و ارائه می‌شود.
*   **PowerMeterCSVExportAPIView:**
    *   صدور داده‌های مصرف برق به فرمت CSV برای تاریخ مشخص.
*   **ValidateJWTToken:**
    *   اعتبارسنجی و تجدید نشان‌های JWT برای کاربران احراز هویت شده.

#### **5\. URLs Django (`urls.py`):**

*   مسیرها:
    *   `/users/`: عملیات CRUD بر روی کاربران.
    *   `/groups/`: عملیات CRUD بر روی گروه‌ها.
    *   `/power/`: عملیات CRUD بر روی داده‌های مصرف برق.
    *   `/realtime/`: اطلاعات مصرف برق به صورت زمان واقعی.
    *   `/daily-stat/`: آمار روزانه برای مصرف برق.
    *   `/energy-stat/`: آمار مصرف انرژی برای بازه‌های زمانی مختلف.
    *   `/power-export/`: صدور داده‌های مصرف برق به فرمت CSV.
    *   `/validate-token/`: اعتبارسنجی و تجدید نشان‌های JWT.

### **Front-end (Next.js)**

#### **پوشه‌ها و فایل‌ها:**

*   **`app/page.js`:**
    *   صفحه اصلی نمایش.
*   **`app/layout.js`:**
    *   طراحی لایه اصلی برای صفحات.
*   **`app/loading.js`:**
    *   نمایش اطلاعات بارگذاری برنامه.
*   **`app/dashboard/page.js`:**
    *   صفحه داشبورد نمایش داده‌های مصرف برق.
*   **`app/dashboard/layout.js`:**
    *   طراحی لایه اصلی برای صفحات داشبورد.
*   **`app/dashboard/login/page.js`:**
    *   صفحه ورود به سیستم.
*   **`components/charts/ColPowerChart.jsx`:**
    *   نمودار مصرف برق در ستون‌ها.
*   **`components/charts/PowerChart.jsx`:**
    *   نمودار کلی مصرف برق.
*   **`components/charts/PiePowerChart.jsx`:**
    *   نمودار دایره‌ای مصرف برق.
*   **`components/charts/PredictCost.jsx`:**
    *   محاسبه و نمایش هزینه مصرف برق.
*   **`components/utils/Download.jsx`:**
    *   امکان دانلود فایل‌ها.
*   **`components/utils/FormatPersianTime.jsx`:**
    *   فرمت‌بندی زمان به شمسی.
*   **`components/utils/LoadCharts.jsx`:**
    *   بارگذاری و نمایش چارت‌ها.
*   **`components/utils/NumberCounter.jsx`:**
    *   نمایش اعداد با افزایش تدریجی.
*   **`components/utils/TranslateToPersian.jsx`:**
    *   ترجمه متن به زبان فارسی.
*   **`components/ChartLayout.jsx`:**
    *   طراحی لایه اصلی برای نمودارها.
*   **`components/DashboardLayout.jsx`:**
    *   طراحی لایه اصلی برای صفحات داشبورد.
*   **`components/Loaders.jsx`:**
    *   انواع لودرها برای نمایش بارگذاری.
*   **`components/Message.jsx`:**
    *   نمایش پیام‌ها.
*   **`components/Navbar.jsx`:**
    *   نوار ناوبری برنامه.
*   **`components/ProtectedPages.jsx`:**
    *   فراهم کردن لایه حفاظت برای صفحات محدود به کاربران وارد شده.
*   **`components/SideBarNav.jsx`:**
    *   ناوبری در کنار صفحات.
*   **`components/UnProtectedPages.jsx`:**
    *   لایه حفاظت برای صفحات عمومی.

#### **پوشه‌ها و فایل‌های عمومی (`public/`):**

*   **`images/`:**
    *   تصاویر مورد استفاده در برنامه.

#### **متغیرها و کانتکست‌ها (`context/`):**

*   **`AuthContext.js`:**
    *   دریافت توکن کاربر و افزودن آن به هدر درخواست‌ها پس از ورود موفق.
*   **`MessageContext.js`:**
    *   مدیریت و نمایش پیام‌ها.
*   **`context.js`:**
    *   فایل کانتکست اصلی برای مدیریت استیت‌های مختلف برنامه.

* * *

این ساختار به کاربر امکان می‌دهد تا با دسترسی به API، از داده‌های مصرف برق خود استفاده کند، فیلترها را اعمال و داده‌ها را به فرمت‌های مختلف صدور کند.
